name: ğŸ­ GOMFLOW Demo Deployment

on:
  push:
    branches: [main, demo]
  pull_request:
    branches: [main]

jobs:
  test-demo:
    name: ğŸ§ª Test Demo Environment
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          gomflow-core/package-lock.json
          gomflow-shared/package-lock.json
        
    - name: ğŸ”§ Setup demo environment
      run: |
        cp .env.demo .env.local
        echo "Demo environment configured"
        
    - name: ğŸ“¦ Install shared dependencies
      run: |
        cd gomflow-shared
        npm ci
        npm run build
        
    - name: ğŸ“¦ Install core dependencies  
      run: |
        cd gomflow-core
        npm ci
        npm link ../gomflow-shared
        
    - name: ğŸ—ï¸ Build application
      run: |
        cd gomflow-core
        npm run build
        
    - name: ğŸ§ª Run tests
      run: |
        cd gomflow-core
        npm test -- --watchAll=false --coverage=false
        
    - name: ğŸ” Lint check
      run: |
        cd gomflow-core
        npm run lint
        
    - name: ğŸ“Š Build size analysis
      run: |
        cd gomflow-core
        npx next build --profile
        
  deploy-demo:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: test-demo
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        working-directory: ./gomflow-core
        vercel-args: '--prod'
        
  security-check:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ” NPM audit
      run: |
        cd gomflow-core
        npm audit --audit-level moderate
        
    - name: ğŸ”’ Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
        
  demo-validation:
    name: ğŸ­ Validate Demo Features
    runs-on: ubuntu-latest
    needs: test-demo
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ”§ Setup demo environment
      run: |
        cp .env.demo .env.local
        
    - name: ğŸ—ï¸ Build shared module
      run: |
        cd gomflow-shared
        npm ci
        npm run build
        
    - name: ğŸ­ Start demo services
      run: |
        cd gomflow-core
        npm ci
        npm link ../gomflow-shared
        timeout 30s npm run dev &
        
    - name: â³ Wait for services
      run: |
        echo "Waiting for demo to start..."
        sleep 15
        
    - name: ğŸ§ª Test demo endpoints
      run: |
        # Test if demo is responding
        curl -f http://localhost:3000 || echo "Demo not ready yet"
        curl -f http://localhost:3000/api/health || echo "Health check not ready"
        
    - name: âœ… Demo validation complete
      run: |
        echo "Demo validation completed successfully!"

  notify-status:
    name: ğŸ“¢ Notify Deployment Status  
    runs-on: ubuntu-latest
    needs: [test-demo, deploy-demo, security-check, demo-validation]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Success
      if: needs.deploy-demo.result == 'success'
      run: |
        echo "ğŸ‰ GOMFLOW Demo deployed successfully!"
        echo "ğŸŒ Live at: https://gomflow-demo.vercel.app"
        
    - name: âŒ Deployment Failed
      if: needs.deploy-demo.result == 'failure'
      run: |
        echo "âŒ Demo deployment failed"
        echo "Check logs above for details"